name: Conformance

# This workflow *only* tries to run the conformance checks. It is triggered periodically on a cron
# to catch when new conformance tests are added and they don't pass.
#
# Without this workflow the new tests wouldn't be noticed until a PR was made.

on:
  # This is needed to trigger the workflow manually from the "Actions" tab in the repo.
  workflow_dispatch:
    inputs: {}
  # Every day at 9am.
  schedule:
    - cron: '0 9 * * *'

jobs:
  test:
    name: Run conformance tests
    runs-on: ubuntu-18.04
    strategy:
      matrix:
        include:
          - otp: 24.0
            elixir: 1.12.1
            protobuf_git: "ref/heads/master"

    steps:
      - uses: actions/checkout@v2

      - name: Update and install dependencies to build protoc locally
        # Dependencies from https://github.com/protocolbuffers/protobuf/blob/master/src/README.md
        run: apt-get update && apt-get install -y autoconf automake libtool curl make g++ unzip jq

      - name: Cache Protobuf
        id: cache-protobuf
        uses: actions/cache@v2
        with:
          path: protobuf
          key: ${{ runner.os }}-${{ matrix.elixir}}-${{ matrix.otp }}-protobuf-${{ protobuf_git }}

      - name: Checkout Protobuf repo
        if: steps.cache-protobuf.outputs.cache-hit != 'true'
        uses: actions/checkout@v2
        with:
          repository: protocolbuffers/protobuf
          ref: ${{ matrix.protobuf_git }}
          path: protobuf

      - name: Build Protobuf and the conformance test runner
        if: steps.cache-protobuf.outputs.cache-hit != 'true'
        working-directory: protobuf
        run: |
          ./autogen.sh
          ./configure
          NUM_CPUS=$(getconf _NPROCESSORS_ONLN)
          make -C ./src -j "${NUM_CPUS}" protoc
          make -C ./conformance conformance-test-runner

      - name: Run mix protobuf.conformance
        run: mix protobuf.conformance --runner=./protobuf/conformance/conformance-test-runner --verbose
